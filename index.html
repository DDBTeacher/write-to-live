<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì ììƒì¡´ - Write to Live</title>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f8f9fa; --danger: #e74c3c; --border: #dfe6e9; --success: #2ecc71; }
        
        body { 
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; 
            background: var(--bg); margin: 0; padding: 20px; color: #333; 
        }
        
        button, input, select, textarea { font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; }

        /* === í—¤ë” ë””ìì¸ === */
        header { 
            display: grid; 
            grid-template-columns: 180px 1fr; 
            border: 2px solid #333; 
            background: white; 
            margin-bottom: 20px;
        }
        .header-left {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border-right: 2px solid #333;
        }
        .header-left img { width: 80px; height: auto; margin-bottom: 5px; }
        
        /* DDBTeacher í…ìŠ¤íŠ¸ */
        .header-left span.brand-name { 
            font-weight: bold; 
            color: black; 
            font-size: 1.1em; 
            text-decoration: none;
            font-family: 'Gowun Dodum', sans-serif; 
        }

        /* [NEW] ì¶”ê°€ëœ ë§í¬ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .header-links {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.85em; /* í°íŠ¸ í¬ê¸° ì¡°ì • */
            width: 100%;
            align-items: center;
            padding-top: 8px;
            border-top: 1px dashed #ddd;
        }
        
        /* ìœ íŠœë¸Œ ë§í¬ ìŠ¤íƒ€ì¼ */
        .header-links a {
            text-decoration: none;
            color: #555;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: 0.2s;
            white-space: nowrap; 
        }
        .header-links a:hover {
            color: var(--accent);
            font-weight: bold;
        }

        /* ì´ë©”ì¼ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ (í´ë¦­ ì•ˆë¨) */
        .header-email {
            color: #555;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: default; /* ë§ˆìš°ìŠ¤ ì»¤ì„œ ê¸°ë³¸ê°’ */
            white-space: nowrap;
        }
        
        /* ë©”ì¸ íƒ€ì´í‹€ */
        .header-title {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em; 
            font-family: 'Gowun Dodum', sans-serif; 
            font-weight: normal;
            flex-direction: column;
        }
        .print-count-area { display: none; font-size: 0.6em; color: red; font-weight: bold; margin-top: 5px; width: 100%; text-align: left; padding-left: 20px;}

        /* ìœ í‹¸ë¦¬í‹° & ë ˆì´ì•„ì›ƒ */
        .container { max-width: 1100px; margin: 0 auto; }
        .flex { display: flex; gap: 10px; align-items: center; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none !important; }
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .w-full { width: 100%; box-sizing: border-box; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button { padding: 6px 14px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; white-space: nowrap; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-blue:hover { background: #2980b9; }
        .btn-gray { background: #95a5a6; color: white; }
        .btn-red { background: var(--danger); color: white; }
        .btn-green { background: var(--success); color: white; }

        /* í›„ì† ìƒë‹´ ë²„íŠ¼ */
        .btn-followup {
            background: white;
            color: var(--accent);
            border: 1px solid var(--accent);
            border-radius: 15px; 
            padding: 2px 10px;
            font-size: 0.85em;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            transition: all 0.2s;
            margin-left: 10px;
        }
        .btn-followup:hover { background: var(--accent); color: white; }
        
        .top-actions { display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .security-notice { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 5px; font-size: 0.9em; line-height: 1.6; margin-bottom: 20px; }

        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .nav-tabs { display: flex; border-bottom: 2px solid #aaa; margin-bottom: 20px; }
        .nav-item { padding: 10px 20px; cursor: pointer; font-weight: bold; color: #777; background: #eee; margin-right: 5px; border-radius: 5px 5px 0 0; }
        .nav-item.active { background: var(--accent); color: white; }

        /* ì…ë ¥ í¼ */
        .input-area { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .input-compact-row { 
            display: flex; gap: 8px; margin-bottom: 10px; align-items: center; flex-wrap: nowrap;
        }
        .input-compact-row input[type="date"] { width: 135px; flex-shrink: 0; }
        .input-compact-row select { flex: 1; min-width: 0; }
        .time-group { display: flex; gap: 5px; flex: 1.2; align-items: center; }
        .time-group select { flex: 1; }
        
        /* ìƒë‹´ ê¸°ë¡ ì¹´ë“œ */
        .record-card { 
            background: white; border: 1px solid #ddd; border-left: 5px solid var(--accent); 
            padding: 10px 20px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .record-card.finished { border-left-color: #95a5a6; background: #f2f2f2; opacity: 0.9; }
        
        .card-header {
            display: flex; align-items: center; gap: 15px; width: 100%;
            padding-bottom: 8px; margin-bottom: 8px; border-bottom: 1px solid #eee;
            white-space: nowrap; overflow-x: auto;    
        }

        .info-text { font-size: 1.0em; color: #333; display: flex; align-items: center; gap: 4px;}
        .info-label { color: #555; margin-right: 5px; display: flex; align-items: center; cursor: pointer; font-size: 0.95em;}
        .record-title { font-weight: bold; font-size: 1.1em; color: var(--primary); margin-bottom: 5px; display: block; border-bottom: 1px dashed #eee; padding-bottom: 5px;}
        .record-content { white-space: pre-wrap; line-height: 1.5; color: #2c3e50; font-size: 1.05em; padding-left: 2px; }

        /* í›„ì† ìƒë‹´ */
        .followup-container { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; }
        .followup-item { background: #f1f8ff; padding: 10px; border-radius: 6px; margin-bottom: 5px; font-size: 0.95em; border-left: 3px solid var(--accent); }
        .followup-date { font-size: 0.8em; color: #777; margin-bottom: 4px; font-weight: bold;}
        .followup-form { margin-top: 10px; display: flex; flex-direction: column; gap: 5px; background: #eee; padding: 10px; border-radius: 5px;}

        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; }
        
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .password-box { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; border: 1px solid #ddd; width: 300px; }
        
        @media print {
            body { background: white; padding: 0; }
            #overlay, .top-actions, .security-notice, .nav-tabs, .input-area, .no-print { display: none !important; }
            header { margin-bottom: 10px; border: 1px solid #000; } 
            .print-count-area { display: block; border-bottom: 2px solid red; margin-bottom: 10px;}
            body.print-selected-only .record-card:not(.print-target) { display: none !important; }
            .record-card { break-inside: avoid; border: 1px solid #555; margin-bottom: 15px; box-shadow: none; page-break-inside: avoid; }
            .card-header { border-bottom: 1px solid #888; flex-wrap: wrap; white-space: normal; }
            input[type="checkbox"] { display: none; } 
            .info-label { margin-right: 10px; }
            .followup-form { display: none !important; }
        }
    </style>
</head>
<body>

<div id="overlay">
    <div class="password-box">
        <h2 id="pwTitle" style="color:var(--primary); margin-top:0;">ğŸ”’ ì ììƒì¡´ Log-in</h2>
        <p id="pwDesc" style="margin-bottom:20px; color:#666; font-size:0.9em;">ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        <input type="password" id="pwInput" maxlength="4" style="width: 100%; text-align: center; font-size: 1.5em; letter-spacing: 5px; margin-bottom:20px;" placeholder="****">
        <div class="flex-between">
            <button class="btn-blue" onclick="checkPw()" style="flex:1;">í™•ì¸</button>
            <button class="btn-gray" onclick="initResetProcess()" style="flex:0.5; margin-left:5px; font-size:0.8em;">ì´ˆê¸°í™”</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="top-actions">
        <button class="btn-gray" onclick="switchTab('students')">í•™ìƒ ëª©ë¡</button>
        <button class="btn-gray" onclick="switchTab('issues')">ìƒë‹´ ì¢…ë¥˜ ëª©ë¡</button>
        <button class="btn-gray" onclick="switchTab('locations')">ì¥ì†Œ ê´€ë¦¬</button>
        <span style="border-right: 1px solid #ccc; margin: 0 5px;"></span>
        <button class="btn-gray" onclick="exportJSON()">ë‚´ë³´ë‚´ê¸°</button>
        <input type="file" id="fileInput" class="hidden" onchange="importJSON(event)">
        <button class="btn-gray" onclick="document.getElementById('fileInput').click()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn-blue" onclick="printPDF()">PDF</button>
        <button class="btn-red" onclick="initResetProcess()">ì´ˆê¸°í™”</button>
    </div>

    <header>
        <div class="header-left">
            <img src="dodo.png" alt="ë„ë„" onerror="this.style.display='none';">
            <span class="brand-name">DDBTeacher</span>
            
            <div class="header-links no-print">
                <a href="https://www.youtube.com/@DDBteacher" target="_blank" title="ìœ íŠœë¸Œ ë°”ë¡œê°€ê¸°">
                    <span style="color:#FF0000; font-size:1.1em;">â–¶</span> YouTube
                </a>
                <div class="header-email">
                    <span style="font-size:1.1em;">âœ‰</span> ddbteacher@naver.com
                </div>
            </div>
        </div>
        
        <div class="header-title">
            <div>- Write to Live - ì ììƒì¡´ -</div>
            <div id="printCountArea" class="print-count-area">ì´ ìƒë‹´ ê±´ìˆ˜: 0íšŒ</div>
        </div>
    </header>

    <div class="security-notice">
        ğŸ”’ <b>ë³´ì•ˆ ì•ˆë‚´:</b> ëª¨ë“  ë°ì´í„°ëŠ” ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•Šê³  í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ê¸°ê¸°ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤. íƒ€ì¸ì€ ë¬¼ë¡  ê°œë°œìë„ ë‚´ìš©ì„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
        ğŸ”’ ìºì‹œì— ì €ì¥ë˜ëŠ” í˜•íƒœì´ë¯€ë¡œ ìºì‹œê°€ ì‚­ì œë  ê²½ìš° ìƒë‹´ ê¸°ë¡ì´ ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤.<br>
        ğŸ”’ ë°±ì—…ì´ í•„ìš”í•œ ê²½ìš° ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥ì„ í™œìš©í•´ì£¼ì„¸ìš”.<br>
        ğŸ”’ ë¶ˆëŸ¬ì˜¤ê¸°ëŠ” [ê¸°ì¡´ë‚´ìš©ì— í†µí•©í•˜ê¸°]ì™€ [ì‚­ì œí•˜ê³  ë®ì–´ì“°ê¸°]ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.<br>
        ğŸ“„ <b>PDFì €ì¥:</b> ëª¨ë“  ë‚´ìš© ì €ì¥(ê°œë³„ ì„ íƒ ì—†ì´): [PDF ì €ì¥] / ê°œë³„ ì €ì¥: [ê°œë³„ ì„ íƒ] - [PDFì €ì¥]
    </div>

    <div class="nav-tabs">
        <div class="nav-item active" onclick="switchTab('main')">ë©”ì¸ í™”ë©´</div>
        <div class="nav-item" id="tab-student-btn" onclick="switchTab('students')" style="display:none;">í•™ìƒ ëª©ë¡</div>
        <div class="nav-item" id="tab-issue-btn" onclick="switchTab('issues')" style="display:none;">ìƒë‹´ ì¢…ë¥˜</div>
        <div class="nav-item" id="tab-loc-btn" onclick="switchTab('locations')" style="display:none;">ì¥ì†Œ ê´€ë¦¬</div>
    </div>

    <div id="tab-main">
        <div class="input-area">
            <div class="input-compact-row">
                <input type="date" id="inputDate" title="ìƒë‹´ ì¼ì">
                <select id="inputStudent" title="í•™ìƒ ì´ë¦„"><option value="">í•™ìƒ ì´ë¦„</option></select>
                <select id="inputIssue" title="ìƒë‹´ ì¢…ë¥˜"><option value="">ìƒë‹´ ì¢…ë¥˜</option></select>
                <select id="inputLocation" title="ìƒë‹´ ì¥ì†Œ"><option value="êµì‹¤">ğŸ  êµì‹¤</option></select>
                
                <div class="time-group">
                    <select id="inputTimeHour">
                        <option value="0">0ì‹œê°„</option>
                        <option value="1">1ì‹œê°„</option>
                        <option value="2">2ì‹œê°„</option>
                        <option value="3">3ì‹œê°„</option>
                    </select>
                    <select id="inputTimeMin">
                        <option value="0">0ë¶„</option>
                        <option value="10" selected>10ë¶„</option>
                        <option value="20">20ë¶„</option>
                        <option value="30">30ë¶„</option>
                        <option value="40">40ë¶„</option>
                        <option value="50">50ë¶„</option>
                    </select>
                </div>
            </div>

            <div class="mb-10" style="margin-bottom: 10px;">
                <input type="text" id="inputTitle" class="w-full" placeholder="ìƒë‹´ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: êµìš°ê´€ê³„ ë©´ë‹´)" style="font-weight:bold;">
            </div>

            <textarea id="inputContent" rows="7" class="w-full" placeholder="ì—¬ê¸°ì— ìƒë‹´ ë‚´ìš©ì„ ê¸°ë¡í•˜ì„¸ìš”..."></textarea>
            <button class="btn-blue mt-10 w-full" onclick="addRecord()">ì €ì¥í•˜ê¸°</button>
        </div>

        <div class="flex" style="background:#eee; padding:10px; border-radius:5px; margin-bottom:20px;">
            <b style="min-width: 70px;">ğŸ” ëª¨ì•„ë³´ê¸°</b>
            <select id="filterStudent" style="flex:1;"><option value="">í•™ìƒ ì´ë¦„</option></select>
            <select id="filterIssue" style="flex:1;"><option value="">ìƒë‹´ ì¢…ë¥˜</option></select>
            <button class="btn-blue" onclick="renderRecords()">ì ìš©</button>
        </div>
            
        <div id="recordList"></div>
    </div>

    <div id="tab-students" class="hidden">
        <div class="flex-between mb-10">
            <h3>ğŸ‘¥ í•™ìƒ ëª©ë¡ ì„¤ì • (1ë²ˆ~30ë²ˆ)</h3>
            <button class="btn-gray" onclick="switchTab('main')">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
        <div class="grid-inputs" id="studentInputs"></div>
        <button class="btn-blue mt-20" onclick="saveSettings()">ì €ì¥</button>
    </div>

    <div id="tab-issues" class="hidden">
        <div class="flex-between mb-10">
            <h3>ğŸ“‚ ìƒë‹´ ì¢…ë¥˜ ì„¤ì • (1ë²ˆ~10ë²ˆ)</h3>
            <button class="btn-gray" onclick="switchTab('main')">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
        <div class="grid-inputs" id="issueInputs"></div>
        <button class="btn-blue mt-20" onclick="saveSettings()">ì €ì¥</button>
    </div>

    <div id="tab-locations" class="hidden">
        <div class="flex-between mb-10">
            <h3>ğŸ  ìƒë‹´ ì¥ì†Œ ì„¤ì • (ê¸°ë³¸: êµì‹¤ + ì¶”ê°€ 9ê°œ)</h3>
            <button class="btn-gray" onclick="switchTab('main')">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
        <p style="color:#666; font-size:0.9em; margin-bottom:10px;">* ì²« ë²ˆì§¸ 'êµì‹¤'ì€ ê¸°ë³¸ê°’ìœ¼ë¡œ ê³ ì •ë©ë‹ˆë‹¤.</p>
        <div class="grid-inputs" id="locationInputs"></div>
        <button class="btn-blue mt-20" onclick="saveSettings()">ì €ì¥</button>
    </div>
</div>

<script>
    // === ë°ì´í„° êµ¬ì¡° ===
    let db = {
        pw: null,
        students: new Array(30).fill(""),
        issues: new Array(10).fill(""),
        locations: new Array(9).fill(""), 
        records: []
    };

    // === ì´ˆê¸°í™” ===
    window.onload = function() {
        const loaded = localStorage.getItem('counseling_db_pro');
        if (loaded) {
            const parsed = JSON.parse(loaded);
            db = { ...db, ...parsed };

            // ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
            if(!db.locations) db.locations = new Array(9).fill("");
            if(db.students.length < 30) db.students = [...db.students, ...new Array(30 - db.students.length).fill("")];
            if(db.issues.length < 10) db.issues = [...db.issues, ...new Array(10 - db.issues.length).fill("")];
            
            db.records.forEach(r => {
                if(!r.followups) r.followups = [];
                if(!r.location) r.location = "êµì‹¤";
                if(!r.timeStr) r.timeStr = "10ë¶„";
                if(!r.title) r.title = "";
            });
        }

        if (!db.pw) {
            document.getElementById('pwTitle').innerText = "ë¹„ë°€ë²ˆí˜¸ ìƒì„±";
            document.getElementById('pwDesc').innerText = "ë‚˜ë§Œ ì•„ëŠ” ì‰¬ìš´ ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì„¤ì •í•˜ì„¸ìš”.";
        }
        
        document.getElementById('inputDate').valueAsDate = new Date();
    };

    // === ë¹„ë°€ë²ˆí˜¸ ë¡œì§ ===
    function checkPw() {
        const input = document.getElementById('pwInput').value;
        if (input.length !== 4) return alert("4ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        if (!db.pw) {
            if (confirm(`ë¹„ë°€ë²ˆí˜¸ë¥¼ '${input}'(ìœ¼)ë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                db.pw = input;
                saveDB();
                alert("ì„¤ì • ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                dismissOverlay();
            }
        } else {
            if (input === db.pw) {
                dismissOverlay();
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                document.getElementById('pwInput').value = "";
            }
        }
    }

    function dismissOverlay() {
        document.getElementById('overlay').classList.add('hidden');
        renderInputs(); 
        refreshSelectOptions();
        renderRecords();
    }

    function initResetProcess() {
        if (!confirm("ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.")) return;
        const rand = Math.floor(1000 + Math.random() * 9000);
        const input = prompt(`[ì´ˆê¸°í™” í™•ì¸]\nì•„ë˜ ìˆ«ìë¥¼ ë˜‘ê°™ì´ ì…ë ¥í•˜ì„¸ìš”.\n\n${rand}`);
        
        if (input == rand) {
            localStorage.removeItem('counseling_db_pro');
            alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
            location.reload();
        } else {
            alert("ìˆ«ìê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    }

    // === íƒ­ ê´€ë¦¬ ===
    function switchTab(tabName) {
        ['main', 'students', 'issues', 'locations'].forEach(t => {
            document.getElementById('tab-' + t).classList.add('hidden');
        });
        
        document.getElementById('tab-' + tabName).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(tabName === 'main') document.querySelector('.nav-item').classList.add('active');
    }

    // === ì„¤ì • ë° ì €ì¥ ===
    function renderInputs() {
        document.getElementById('studentInputs').innerHTML = db.students.map((val, i) => `
            <div><small>ë²ˆí˜¸ ${i+1}</small><input type="text" id="std_${i}" value="${val}" placeholder="í•™ìƒ ì´ë¦„"></div>
        `).join('');

        document.getElementById('issueInputs').innerHTML = db.issues.map((val, i) => `
            <div><small>ìˆœë²ˆ ${i+1}</small><input type="text" id="iss_${i}" value="${val}" placeholder="ìƒë‹´ ì¢…ë¥˜"></div>
        `).join('');

        document.getElementById('locationInputs').innerHTML = db.locations.map((val, i) => `
            <div><small>ì¶”ê°€ ${i+1}</small><input type="text" id="loc_${i}" value="${val}" placeholder="ì¥ì†Œëª…"></div>
        `).join('');
    }

    function saveSettings() {
        const oldIssues = [...db.issues];
        for(let i=0; i<30; i++) db.students[i] = document.getElementById(`std_${i}`).value.trim();
        for(let i=0; i<10; i++) db.issues[i] = document.getElementById(`iss_${i}`).value.trim();
        for(let i=0; i<9; i++) db.locations[i] = document.getElementById(`loc_${i}`).value.trim();

        // ì´ìŠˆ ì´ë¦„ ë³€ê²½ ì‹œ ê¸°ì¡´ ê¸°ë¡ ì—…ë°ì´íŠ¸
        oldIssues.forEach((oldVal, idx) => {
            const newVal = db.issues[idx];
            if (oldVal !== "" && newVal === "") {
                db.records.forEach(r => { if (r.issue === oldVal) r.issue = "ê¸°íƒ€"; });
            } else if (oldVal !== "" && newVal !== "" && oldVal !== newVal) {
                db.records.forEach(r => { if (r.issue === oldVal) r.issue = newVal; });
            }
        });

        saveDB();
        refreshSelectOptions();
        renderRecords();
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        switchTab('main');
    }

    function refreshSelectOptions() {
        const makeOpt = (arr, type, defaultVal = null) => {
            let html = `<option value="">${type}</option>`;
            if (defaultVal) html = `<option value="${defaultVal}">${defaultVal}</option>`;
            arr.forEach(val => { if(val) html += `<option value="${val}">${val}</option>`; });
            if (!defaultVal) html += `<option value="ê¸°íƒ€">ê¸°íƒ€</option>`;
            return html;
        };
        const sOpt = makeOpt(db.students, "í•™ìƒ ì´ë¦„");
        const iOpt = makeOpt(db.issues, "ìƒë‹´ ì¢…ë¥˜");
        const lOpt = makeOpt(db.locations, "ìƒë‹´ ì¥ì†Œ", "êµì‹¤"); 

        document.getElementById('inputStudent').innerHTML = sOpt;
        document.getElementById('filterStudent').innerHTML = sOpt;
        document.getElementById('inputIssue').innerHTML = iOpt;
        document.getElementById('filterIssue').innerHTML = iOpt;
        document.getElementById('inputLocation').innerHTML = lOpt;
    }

    // === ê¸°ë¡ CRUD ===
    function addRecord() {
        const date = document.getElementById('inputDate').value;
        const student = document.getElementById('inputStudent').value;
        const issue = document.getElementById('inputIssue').value;
        const location = document.getElementById('inputLocation').value || "êµì‹¤";
        const title = document.getElementById('inputTitle').value.trim();
        const content = document.getElementById('inputContent').value;
        
        let h = document.getElementById('inputTimeHour').value;
        let m = document.getElementById('inputTimeMin').value;
        if(h == "0" && m == "0") m = "10";
        const timeStr = (h == "0") ? `${m}ë¶„` : `${h}ì‹œê°„ ${m}ë¶„`;

        if(!date || !content) return alert("ë‚ ì§œì™€ ë‚´ìš©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

        db.records.push({
            id: Date.now(),
            date,
            student: student || "ê¸°íƒ€",
            issue: issue || "ê¸°íƒ€",
            location,
            timeStr,
            title,
            content,
            finished: false,
            pdfChecked: false,
            followups: []
        });
        
        // ì…ë ¥ì°½ ì´ˆê¸°í™”
        document.getElementById('inputContent').value = "";
        document.getElementById('inputTitle').value = "";
        document.getElementById('inputTimeHour').value = "0";
        document.getElementById('inputTimeMin').value = "10";
        
        saveDB();
        renderRecords();
    }

    function renderRecords() {
        const fStu = document.getElementById('filterStudent').value;
        const fIss = document.getElementById('filterIssue').value;
        const list = document.getElementById('recordList');

        let filtered = db.records.filter(r => (!fStu || r.student === fStu) && (!fIss || r.issue === fIss));
        filtered.sort((a, b) => (a.finished - b.finished) || (new Date(b.date) - new Date(a.date)));

        const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

        list.innerHTML = filtered.map(r => {
            const d = new Date(r.date);
            const dateStr = `${r.date} (${days[d.getDay()]})`;

            const followupHtml = r.followups.map(f => `
                <div class="followup-item">
                    <div class="followup-date">â†ª ${f.date} (í›„ì† ì¡°ì¹˜)</div>
                    ${f.content}
                </div>
            `).join('');

            return `
            <div class="record-card ${r.finished ? 'finished' : ''} ${r.pdfChecked ? 'print-target' : ''}">
                <div class="card-header">
                    <span class="info-text">ğŸ“… ${dateStr}</span>
                    <span class="info-text">ğŸ‘¤ <b>${r.student}</b></span>
                    <span class="info-text">ğŸ“‚ ${r.issue}</span>
                    <span class="info-text">ğŸ  ${r.location}</span>
                    <span class="info-text">â° ${r.timeStr}</span>
                    
                    <span class="btn-followup no-print" onclick="toggleFollowupForm(${r.id})">
                        â†ª í›„ì†ì¶”ê°€
                    </span>

                    <label class="info-label no-print" style="margin-left:10px;">
                        PDF <input type="checkbox" style="margin-left:3px;" onchange="togglePdfCheck(${r.id})" ${r.pdfChecked ? 'checked' : ''}>
                    </label>

                    <label class="info-label no-print" style="margin-left:5px;">
                        ì¢…ë£Œ <input type="checkbox" style="margin-left:3px;" onchange="toggleFinish(${r.id})" ${r.finished ? 'checked' : ''}>
                    </label>
                    
                    <button class="btn-red no-print" onclick="deleteRecord(${r.id})" style="padding:4px 10px; font-size:0.85em; margin-left:auto;">ì‚­ì œ</button>
                </div>
                
                ${r.title ? `<div class="record-title">${r.title}</div>` : ''}
                <div class="record-content">${r.content}</div>

                <div class="followup-container ${r.followups.length === 0 ? 'hidden' : ''}">
                    ${followupHtml}
                </div>

                <div id="followup-form-${r.id}" class="followup-form hidden no-print">
                    <textarea id="f-text-${r.id}" rows="2" placeholder="í›„ì† ì¡°ì¹˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <div style="text-align:right;">
                        <button class="btn-blue" onclick="saveFollowup(${r.id})" style="padding:4px 10px; font-size:0.9em;">ì €ì¥í•˜ê¸°</button>
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

    // === í›„ì† ìƒë‹´ ê¸°ëŠ¥ ===
    function toggleFollowupForm(id) {
        document.getElementById(`followup-form-${id}`).classList.toggle('hidden');
    }

    function saveFollowup(id) {
        const text = document.getElementById(`f-text-${id}`).value;
        if(!text.trim()) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        
        const r = db.records.find(item => item.id === id);
        if(r) {
            const today = new Date();
            const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            
            if(!r.followups) r.followups = [];
            r.followups.push({ id: Date.now(), content: text, date: dateStr });
            
            saveDB(); renderRecords();
        }
    }

    function toggleFinish(id) {
        const r = db.records.find(item => item.id === id);
        if(r) { r.finished = !r.finished; saveDB(); renderRecords(); }
    }

    function togglePdfCheck(id) {
        const r = db.records.find(item => item.id === id);
        if(r) { r.pdfChecked = !r.pdfChecked; saveDB(); renderRecords(); }
    }

    function deleteRecord(id) {
        if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) {
            db.records = db.records.filter(r => r.id !== id);
            saveDB();
            renderRecords();
        }
    }

    function saveDB() {
        localStorage.setItem('counseling_db_pro', JSON.stringify(db));
    }

    // === ë°±ì—…/ë³µì›/PDF ===
    function exportJSON() {
        const blob = new Blob([JSON.stringify(db, null, 2)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `ìƒë‹´ë°±ì—…_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function importJSON(event) {
        const file = event.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const loaded = JSON.parse(e.target.result);
                if(!loaded.locations) loaded.locations = new Array(9).fill("");

                const choice = confirm("í™•ì¸: [ê¸°ì¡´ë‚´ìš©ì— í†µí•©í•˜ê¸°]\nì·¨ì†Œ: [ì‚­ì œí•˜ê³  ë®ì–´ì“°ê¸°]");
                
                if(choice) { 
                    loaded.students.forEach(s => {
                        if(s && !db.students.includes(s)) {
                            const empty = db.students.indexOf("");
                            if(empty !== -1) db.students[empty] = s;
                        }
                    });
                    loaded.issues.forEach(i => {
                        if(i && !db.issues.includes(i)) {
                            const empty = db.issues.indexOf("");
                            if(empty !== -1) db.issues[empty] = i;
                        }
                    });
                    loaded.locations.forEach(l => {
                        if(l && !db.locations.includes(l)) {
                            const empty = db.locations.indexOf("");
                            if(empty !== -1) db.locations[empty] = l;
                        }
                    });

                    const ids = new Set(db.records.map(r => r.id));
                    const newRecs = loaded.records.filter(r => !ids.has(r.id));
                    db.records = [...db.records, ...newRecs];
                    alert("í†µí•© ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else { 
                    if(confirm("ê¸°ì¡´ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?")) {
                        db = loaded;
                        alert("ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else return;
                }
                saveDB();
                location.reload();
            } catch(err) { alert("íŒŒì¼ ì˜¤ë¥˜ì…ë‹ˆë‹¤."); }
        };
        reader.readAsText(file);
    }

    function printPDF() {
        const hasChecked = db.records.some(r => r.pdfChecked);
        let targetRecords = db.records;

        if (hasChecked) {
            document.body.classList.add('print-selected-only'); 
            targetRecords = db.records.filter(r => r.pdfChecked);
        } else {
            document.body.classList.remove('print-selected-only'); 
        }

        let mainCount = targetRecords.length;
        let subCount = targetRecords.reduce((acc, r) => acc + (r.followups ? r.followups.length : 0), 0);
        let total = mainCount + subCount;

        document.getElementById('printCountArea').innerText = `ì´ ìƒë‹´ ê±´ìˆ˜: ${total}íšŒ (ë³¸ ìƒë‹´ ${mainCount}ê±´ + í›„ì† ${subCount}ê±´)`;

        window.print();
        document.body.classList.remove('print-selected-only');
    }
</script>

</body>
</html>
